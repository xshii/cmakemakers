# CMakeLists.txt 混合内容管理

## 功能概述

CMakeMakers 支持在同一个 `CMakeLists.txt` 文件中**混合手动编写和自动生成的内容**：

- ✅ **保护手动内容** - 你的手动编写内容永远不会被覆盖
- ✅ **智能追加** - 自动生成的部分追加到文件末尾
- ✅ **清晰标记** - 使用特殊注释标记自动生成的区域
- ✅ **自动替换** - 每次生成时自动替换旧的自动生成部分
- ✅ **历史清理** - 处理多个历史自动生成记录

---

## 工作原理

### 1. 特殊注释标记

自动生成的内容使用明确的注释边界标记：

```cmake
# ============================================================================
# BEGIN: Generated by CMakeMakers - DO NOT EDIT THIS SECTION
# Configuration: cmake/cmaker_config.yaml
# Generated at: 2025-11-13T12:00:00Z
# ============================================================================

# 这里是自动生成的内容
project(MyProject VERSION 1.0.0)
add_executable(my_app src/main.cpp)
# ...

# ============================================================================
# END: Generated by CMakeMakers
# ============================================================================
```

### 2. 智能合并策略

当你运行 "CMakeMakers: Generate CMakeLists.txt" 时：

1. **读取现有文件**（如果存在）
2. **移除所有自动生成区域**（通过 BEGIN/END 标记识别）
3. **保留所有手动编写内容**
4. **在文件末尾追加新的自动生成区域**

### 3. 冲突检测和提示

- 如果文件**不存在** → 直接创建，包含自动生成内容
- 如果文件**已存在且包含自动生成标记** → 直接更新（静默替换）
- 如果文件**已存在且没有标记** → 弹出提示，征求用户同意

---

## 使用场景

### 场景 1: 第一次生成（文件不存在）

**操作**：运行 "CMakeMakers: Generate CMakeLists.txt"

**结果**：创建新的 `CMakeLists.txt`，包含自动生成的内容

```cmake
# ============================================================================
# BEGIN: Generated by CMakeMakers - DO NOT EDIT THIS SECTION
# Configuration: cmake/cmaker_config.yaml
# Generated at: 2025-11-13T12:00:00Z
# ============================================================================

project(MyProject VERSION 1.0.0 LANGUAGES CXX)
set(CMAKE_CXX_STANDARD 17)
add_executable(my_app src/main.cpp)

# ============================================================================
# END: Generated by CMakeMakers
# ============================================================================
```

---

### 场景 2: 添加手动自定义内容

你可以在自动生成区域**之前**添加任何自定义内容：

```cmake
# ===== 我的自定义配置 =====
message("Building MyProject")
set(MY_CUSTOM_VAR "custom_value")

# 添加自定义宏
add_compile_definitions(MY_CUSTOM_DEFINE)

# 设置额外的编译选项
if(CMAKE_BUILD_TYPE STREQUAL "Debug")
  add_compile_options(-fsanitize=address)
endif()

# ============================================================================
# BEGIN: Generated by CMakeMakers - DO NOT EDIT THIS SECTION
# Configuration: cmake/cmaker_config.yaml
# Generated at: 2025-11-13T12:00:00Z
# ============================================================================

project(MyProject VERSION 1.0.0 LANGUAGES CXX)
set(CMAKE_CXX_STANDARD 17)
add_executable(my_app src/main.cpp)

# ============================================================================
# END: Generated by CMakeMakers
# ============================================================================
```

**重要**：自定义内容应该写在 `BEGIN` 标记**之前**，不要修改标记之间的内容。

---

### 场景 3: 更新配置后重新生成

**操作**：
1. 修改 `cmake/cmaker_config.yaml`（如添加新的源文件）
2. 运行 "CMakeMakers: Generate CMakeLists.txt"

**结果**：自动生成的部分被更新，手动内容保持不变

```cmake
# ===== 我的自定义配置（保持不变）=====
message("Building MyProject")
set(MY_CUSTOM_VAR "custom_value")

# ============================================================================
# BEGIN: Generated by CMakeMakers - DO NOT EDIT THIS SECTION
# Configuration: cmake/cmaker_config.yaml
# Generated at: 2025-11-13T14:30:00Z  ← 新的时间戳
# ============================================================================

project(MyProject VERSION 1.0.0 LANGUAGES CXX)
set(CMAKE_CXX_STANDARD 17)
add_executable(my_app
  src/main.cpp
  src/new_file.cpp  ← 新增的文件
)

# ============================================================================
# END: Generated by CMakeMakers
# ============================================================================
```

---

### 场景 4: 手动编辑的 CMakeLists.txt

如果你已经有一个手动编写的 `CMakeLists.txt`：

```cmake
# 已有的手动 CMakeLists.txt
project(ExistingProject)
add_executable(existing_app main.cpp)
```

**第一次运行生成时**，会弹出提示：

```
CMakeLists.txt 已存在且包含手动编写的内容。
CMakeMakers 将在文件末尾追加自动生成的部分，并用特殊注释标记。
你的手动内容不会被覆盖。

[继续追加]  [取消]
```

**点击"继续追加"后**：

```cmake
# 已有的手动 CMakeLists.txt（保持不变）
project(ExistingProject)
add_executable(existing_app main.cpp)

# ============================================================================
# BEGIN: Generated by CMakeMakers - DO NOT EDIT THIS SECTION
# Configuration: cmake/cmaker_config.yaml
# Generated at: 2025-11-13T12:00:00Z
# ============================================================================

project(MyProject VERSION 1.0.0 LANGUAGES CXX)
set(CMAKE_CXX_STANDARD 17)
add_executable(my_app src/main.cpp)

# ============================================================================
# END: Generated by CMakeMakers
# ============================================================================
```

---

### 场景 5: 处理历史遗留的多个自动生成区域

如果文件中意外存在多个自动生成区域（可能因为错误或手动编辑）：

```cmake
# 手动内容
set(VAR1 "a")

# BEGIN: Generated by CMakeMakers - DO NOT EDIT THIS SECTION
project(OldProject1)
# END: Generated by CMakeMakers

# 更多手动内容
set(VAR2 "b")

# BEGIN: Generated by CMakeMakers - DO NOT EDIT THIS SECTION
project(OldProject2)
# END: Generated by CMakeMakers
```

**重新生成后**，所有旧的自动生成区域都被清理：

```cmake
# 手动内容
set(VAR1 "a")

# 更多手动内容
set(VAR2 "b")

# ============================================================================
# BEGIN: Generated by CMakeMakers - DO NOT EDIT THIS SECTION
# Configuration: cmake/cmaker_config.yaml
# Generated at: 2025-11-13T12:00:00Z
# ============================================================================

project(NewProject VERSION 1.0.0)
add_executable(new_app src/main.cpp)

# ============================================================================
# END: Generated by CMakeMakers
# ============================================================================
```

---

## 最佳实践

### ✅ 推荐做法

1. **手动内容放在文件开头**
   ```cmake
   # 自定义配置
   set(MY_VAR "value")

   # 自动生成区域
   # BEGIN: Generated by CMakeMakers...
   ```

2. **不要编辑自动生成区域**
   - 标记之间的内容会在每次生成时被替换
   - 修改会丢失

3. **使用注释分隔不同部分**
   ```cmake
   # ========== 全局配置 ==========
   set(CMAKE_BUILD_TYPE Release)

   # ========== 自定义选项 ==========
   option(ENABLE_TESTS "Enable testing" ON)

   # ========== CMakeMakers 自动生成 ==========
   # BEGIN: Generated by CMakeMakers...
   ```

4. **定期重新生成**
   - 修改配置文件后立即生成
   - 确保 CMakeLists.txt 与配置同步

### ❌ 避免的做法

1. **不要在 BEGIN/END 标记之间添加手动内容**
   ```cmake
   # BEGIN: Generated by CMakeMakers
   project(MyProject)
   set(MY_VAR "value")  ❌ 会被清除！
   # END: Generated by CMakeMakers
   ```

2. **不要删除或修改标记**
   ```cmake
   # BEGIN: Generated by CMakeMakers  ← 不要删除
   # ...
   # END: Generated by CMakeMakers    ← 不要删除
   ```

3. **不要手动创建多个自动生成区域**
   - 只会保留最后生成的区域
   - 其他区域会被清理

---

## 技术细节

### 标记格式

**BEGIN 标记**：
```cmake
# ============================================================================
# BEGIN: Generated by CMakeMakers - DO NOT EDIT THIS SECTION
# Configuration: <相对路径>
# Generated at: <ISO时间戳>
# ============================================================================
```

**END 标记**：
```cmake
# ============================================================================
# END: Generated by CMakeMakers
# ============================================================================
```

### 移除算法

1. 查找 `# BEGIN: Generated by CMakeMakers`
2. 查找对应的 `# END: Generated by CMakeMakers`
3. 移除整个区域（包括分隔线）
4. 重复直到没有更多标记
5. 处理格式错误的情况（BEGIN 没有对应的END）

### 文件结构

```
┌─────────────────────────────────────┐
│  手动编写的内容                      │
│  (用户自定义配置、宏、选项等)        │
├─────────────────────────────────────┤
│  空行 (自动添加，保持间隔)           │
├─────────────────────────────────────┤
│  BEGIN: Generated by CMakeMakers    │  ← 标记开始
│  配置路径、时间戳                    │
│  ═══════════════════════════════════ │
│                                      │
│  自动生成的 CMake 代码               │
│  (project, targets, options等)      │
│                                      │
│  ═══════════════════════════════════ │
│  END: Generated by CMakeMakers      │  ← 标记结束
└─────────────────────────────────────┘
```

---

## 测试覆盖

所有功能都有完整的单元测试，参见：
- `src/test/suite/cmakeFileManager.test.ts` (13 个测试)

**测试场景**：
- ✅ 创建新文件
- ✅ 保留手动内容
- ✅ 替换旧的自动生成区域
- ✅ 处理多个自动生成区域（遗留问题）
- ✅ 处理格式错误的标记（BEGIN 没有 END）
- ✅ 正确的空行间隔
- ✅ 检测自动生成区域
- ✅ 提取手动内容

运行测试：
```bash
npm test
```

---

## FAQ

**Q: 自动生成区域可以放在文件中间吗？**
A: 不建议。当前实现总是追加到文件末尾。如果你需要特定顺序，可以在手动区域使用 `include()` 或 `add_subdirectory()`。

**Q: 可以有多个自动生成区域吗？**
A: 从逻辑上不支持。每次生成会清除所有旧的区域，只保留最新的一个。

**Q: 如果我不小心删除了 END 标记会怎样？**
A: 下次生成时，会从 BEGIN 标记开始移除到文件末尾的所有内容，然后追加新的生成内容。所以请不要删除标记。

**Q: 可以关闭自动标记功能吗？**
A: 当前版本不支持。标记是保护手动内容的核心机制。

**Q: 如果我想完全手动管理 CMakeLists.txt 怎么办？**
A: 简单！不要运行 "CMakeMakers: Generate CMakeLists.txt" 命令，手动编写即可。CMakeMakers 不会主动修改你的文件。

---

## 相关文档

- **实现代码**: `src/utils/cmakeFileManager.ts`
- **测试代码**: `src/test/suite/cmakeFileManager.test.ts`
- **扩展集成**: `src/extension.ts` (line 102-142)
- **智能放置**: `docs/test-cases-smart-placement.md`

---

**版本**: 0.0.1
**最后更新**: 2025-11-13
**测试状态**: ✅ 48/48 通过
